# build_exe.py - –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è EXE —Ñ–∞–π–ª—É
import subprocess
import sys
import os


def install_requirements():
    """–í—Å—Ç–∞–Ω–æ–≤–ª—é—î –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–∞–∫–µ—Ç–∏"""
    print("üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π...")
    subprocess.check_call([sys.executable, "-m", "pip", "install", "pyinstaller"])
    subprocess.check_call([sys.executable, "-m", "pip", "install", "-r", "requirements.txt"])


def build_exe():
    """–°—Ç–≤–æ—Ä—é—î EXE —Ñ–∞–π–ª –∑ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—î—é –¥–ª—è –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—ñ"""
    print("üî® –°—Ç–≤–æ—Ä–µ–Ω–Ω—è EXE —Ñ–∞–π–ª—É...")

    # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è PyInstaller –∑ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è–º–∏ –¥–ª—è –±–∞–≥–∞—Ç–æ–ø—Ä–æ—Ü–µ—Å–æ—Ä–Ω–æ—Å—Ç—ñ
    cmd = [
        "pyinstaller",
        "--onefile",  # –û–¥–∏–Ω —Ñ–∞–π–ª
        "--windowed",  # –ë–µ–∑ –∫–æ–Ω—Å–æ–ª—ñ (—Ç—ñ–ª—å–∫–∏ GUI)
        "--name=DocxGenerator",  # –Ü–º'—è —Ñ–∞–π–ª—É
        "--icon=icon.ico",  # –Ü–∫–æ–Ω–∫–∞ (—è–∫—â–æ —î)
        "--add-data=requirements.txt;.",  # –î–æ–¥–∞—î–º–æ requirements.txt
        "--hidden-import=pandas",  # –Ø–≤–Ω–æ –≤–∫–∞–∑—É—î–º–æ –º–æ–¥—É–ª—ñ
        "--hidden-import=docxtpl",
        "--hidden-import=jinja2",
        "--hidden-import=openpyxl",
        "--hidden-import=concurrent.futures",
        "--hidden-import=multiprocessing",
        "--hidden-import=multiprocessing.spawn",  # –î–ª—è ProcessPoolExecutor
        "--hidden-import=pickle",  # –î–ª—è —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –º—ñ–∂ –ø—Ä–æ—Ü–µ—Å–∞–º–∏
        "--hidden-import=utils",  # –ù–∞—à –º–æ–¥—É–ª—å utils
        "--optimize=2",  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
        "--strip",  # –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ —Å–∏–º–≤–æ–ª–∏
        "--noupx",  # –í—ñ–¥–∫–ª—é—á–∞—î–º–æ UPX (–º–æ–∂–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É–≤–∞—Ç–∏ –∑ –±–∞–≥–∞—Ç–æ–ø—Ä–æ—Ü–µ—Å–æ—Ä–Ω—ñ—Å—Ç—é)
        "main.py"
    ]

    # –í–∏–¥–∞–ª—è—î–º–æ —ñ–∫–æ–Ω–∫—É –∑ –∫–æ–º–∞–Ω–¥–∏, —è–∫—â–æ —Ñ–∞–π–ª –Ω–µ —ñ—Å–Ω—É—î
    if not os.path.exists("icon.ico"):
        cmd.remove("--icon=icon.ico")

    try:
        subprocess.check_call(cmd)
        print("‚úÖ EXE —Ñ–∞–π–ª —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!")
        print("üìÅ –ó–Ω–∞–π–¥—ñ—Ç—å —Ñ–∞–π–ª DocxGenerator.exe –≤ –ø–∞–ø—Ü—ñ dist/")

        # –°—Ç–≤–æ—Ä—é—î–º–æ –¥–æ–≤—ñ–¥–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
        create_readme()

    except subprocess.CalledProcessError as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ EXE: {e}")
        return False

    return True


def create_readme():
    """–°—Ç–≤–æ—Ä—é—î README —Ñ–∞–π–ª –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
    readme_content = """
# DOCX Generator - –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é

## –°–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–º–æ–≥–∏
- Windows 7/8/10/11 (64-bit)
- –ú—ñ–Ω—ñ–º—É–º 4 –ì–ë RAM
- –î–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏: –±–∞–≥–∞—Ç–æ—è–¥–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å–æ—Ä

## –Ø–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏

1. **–ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ —Ñ–∞–π–ª–∏:**
   - main.xlsx - –æ—Å–Ω–æ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è (–∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫ = –æ–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç)
   - –î–æ–¥–∞—Ç–∫–æ–≤—ñ .xlsx —Ñ–∞–π–ª–∏ - —Ç–∞–±–ª–∏—Ü—ñ –∑ –¥–µ—Ç–∞–ª—è–º–∏
   - template.docx - Word —à–∞–±–ª–æ–Ω –∑ Jinja2 –∑–º—ñ–Ω–Ω–∏–º–∏

2. **–ó–∞–ø—É—Å—Ç—ñ—Ç—å DocxGenerator.exe**

3. **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏:**
   - –û–±–µ—Ä—ñ—Ç—å –ø–∞–ø–∫—É –∑ Excel —Ñ–∞–π–ª–∞–º–∏
   - –í–∫–∞–∂—ñ—Ç—å –æ—Å–Ω–æ–≤–Ω–∏–π Excel —Ñ–∞–π–ª (main.xlsx)
   - –û–±–µ—Ä—ñ—Ç—å Word —à–∞–±–ª–æ–Ω (template.docx)
   - –í–∫–∞–∂—ñ—Ç—å –ø–∞–ø–∫—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
   - –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –Ω–∞–∑–≤–∏ —Å—Ç–æ–≤–ø—Ü—ñ–≤

4. **–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–°—Ç–∞—Ä—Ç"**

## –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ

–ü—Ä–æ–≥—Ä–∞–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î 50% —è–¥–µ—Ä –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó —à–≤–∏–¥–∫–æ—Å—Ç—ñ
- –ü–æ–∫–∞–∑—É—î –ø—Ä–æ–≥—Ä–µ—Å –æ–±—Ä–æ–±–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
- –î–æ–∑–≤–æ–ª—è—î –∑—É–ø–∏–Ω–∏—Ç–∏ –ø—Ä–æ—Ü–µ—Å –∫–Ω–æ–ø–∫–æ—é "–°—Ç–æ–ø"

## –ü—Ä–∏–∫–ª–∞–¥ –∑–º—ñ–Ω–Ω–∏—Ö —É Word —à–∞–±–ª–æ–Ω—ñ

```
{{ name_credit }} - –∑–Ω–∞—á–µ–Ω–Ω—è –∑—ñ —Å—Ç–æ–≤–ø—Ü—è "name" –æ—Å–Ω–æ–≤–Ω–æ—ó —Ç–∞–±–ª–∏—Ü—ñ
{{ transactions_table }} - —Ç–∞–±–ª–∏—Ü—è –∑ —Ñ–∞–π–ª—É "transactions.xlsx"
{{ amount_credit|floatformat:2 }} - —á–∏—Å–ª–æ –∑ 2 –∑–Ω–∞–∫–∞–º–∏ –ø—ñ—Å–ª—è –∫–æ–º–∏
```

## –ü—ñ–¥—Ç—Ä–∏–º–∫–∞
–Ø–∫—â–æ –≤–∏–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º–∏ - –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:
1. –í—Å—ñ Excel —Ñ–∞–π–ª–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—é—Ç—å—Å—è –≤ Excel
2. Word —à–∞–±–ª–æ–Ω –º—ñ—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ Jinja2
3. –ù–∞–∑–≤–∏ —Å—Ç–æ–≤–ø—Ü—ñ–≤ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å —É –≤—Å—ñ—Ö —Ñ–∞–π–ª–∞—Ö
"""

    with open("README_USER.txt", "w", encoding="utf-8") as f:
        f.write(readme_content)

    print("üìÑ –°—Ç–≤–æ—Ä–µ–Ω–æ —Ñ–∞–π–ª README_USER.txt –∑ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏")


if __name__ == "__main__":
    print("üöÄ –ü–æ—á–∞—Ç–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è EXE —Ñ–∞–π–ª—É...")
    print("‚ö° –ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω—ñ—Å—Ç—å –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó —à–≤–∏–¥–∫–æ—Å—Ç—ñ")

    try:
        install_requirements()
        if build_exe():
            print("\nüéâ –ì–æ—Ç–æ–≤–æ! –í–∞—à EXE —Ñ–∞–π–ª –≥–æ—Ç–æ–≤–∏–π –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.")
            print("üí° –ü—Ä–æ–≥—Ä–∞–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î –ø–æ–ª–æ–≤–∏–Ω—É —è–¥–µ—Ä –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞")
        else:
            print("\n‚ùå –í–∏–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º–∏ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ EXE")
    except KeyboardInterrupt:
        print("\n‚õî –ü—Ä–æ—Ü–µ—Å –ø–µ—Ä–µ—Ä–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º")
    except Exception as e:
        print(f"\n‚ùå –ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")